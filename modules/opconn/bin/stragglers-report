#!/bin/bash

CONNECTIONS=$(lsof -i |grep -E 'http.+ESTABLISHED' )
CONNCOUNT=$(echo "$CONNECTIONS"|wc -l)
SERVERS=$(echo "$CONNECTIONS" |sed -r 's/^.+->([^:]+):.+$/\1/'|sort|uniq)
PORTSERV=$(echo "$CONNECTIONS" |sed -r 's/^.+:(.+)->([^:]+):.+$/\1:\2/'|sort|uniq)

# lib loading
LIBF="$HOME/bin/lib/straggle-lib.sh"
if [[ -f "$LIBF" ]]; then
	. "$LIBF"
else
	echo "No function library found for stragglers. Abort."
	exit 126
fi

# define SERVERNAME, FROM and RCPT
CONFF="$HOME/.config/stragglers.conf"
[[ -f "$CONFF" ]] && . "$CONFF"

[[ $(echo -e "$THRESHOLD\n$SERVERNAME\n$FROM\n$RCPT\n$DBNAME\n$DBUSER\n$DBPASS"|sort|uniq|wc -l) -ne 7 ]] && {
	echo "Verify configuration file $CONFF"
	exit 127
}

# ============== Do it now

if [[ -z "$CONNECTIONS" ]]; then
	echo "Nothing to report."
	exit
else
	echo "Generating and sending report for $CONNCOUNT connections."
fi

echo "$PORTSERV" | while read pserv; do
	md5id=$(stg_md5 "$pserv")
	if [[ $(stg_getcontent $md5id|wc -l) -gt 0 ]]; then
		stg_setnotes $md5id "Old connection $(date "+%F-%T") $pserv"
		# do some other stuff here?
		# for ex ban the IP in question?
	else
		stg_insert "$pserv"
	fi
done

IPpat="^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$" # I don't expect a wildly invalid IP to be returned by DNS tools...
#IPpat2="^(([12]?)[0-9])?[0-9]\.(([12]?)[0-9])?[0-9]\.(([12]?)[0-9])?[0-9]\.(([12]?)[0-9])?[0-9]\.$" # more precise but I'm less sure of its validity
ABUSEF=/tmp/abuse
echo "">$ABUSEF
echo "$SERVERS"|while read SERV ; do
	[[ "$SERV" =~ $IPpat ]] || SERV=$(nslookup "$SERV" |egrep '^Name:' -A 1|grep 'Address:'|sed -r 's/Address:\s*//')
	echo "$SERV" | while read myaddr; do # cater for: if it was a name resolved to multiple addresses
		echo -e "\t// $myaddr" >> "$ABUSEF"
		whois "$myaddr"|egrep -i '((net|name).+:)|(abuse.*:)|Abuse contact|OrgAbuseEmail|OrgName' >> "$ABUSEF"
	done
done

REPORTFILE="/tmp/report-$(date "+%F-%T")"
cat <<EOF > "$REPORTFILE"

Report for $SERVERNAME

Connections: $CONNCOUNT


$(
if [[ $(egrep . stg_show_all -c) -gt 1 ]]; then
	echo -e "	==== Apache Task ====\n\nRestarting apache\n"
	service apache2 restart 2>&1
	if [[ $? -gt 0 ]]; then
		service --status-all | mailx -s "URGENT - $SERVERNAME apache restart failed" -r "$FROM" "$RCPT"
	else
		stg_clearout
		stg_drop # drop the now-obsolete old-connection artefacts
	fi
fi
)

	==== Servers involved ====

$SERVERS

	==== Abuse details ====

$(cat $ABUSEF)

	==== Ports to server ====

$PORTSERV

EOF

if [[ "$@" =~ "--stdout" ]]; then
	cat "$REPORTFILE" | less
else
	cat "$REPORTFILE"   | mailx -s "$SERVERNAME Open connections: $CONNCOUNT" -r "$FROM" "$RCPT"
fi

