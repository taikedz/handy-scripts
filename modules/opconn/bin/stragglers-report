#!/bin/bash

CONNECTIONS=$(lsof -i |grep -E 'http.+ESTABLISHED' )
CONNCOUNT=$(echo "$CONNECTIONS"|wc -l)
SERVERS=$(echo "$CONNECTIONS" |sed -r 's/^.+->([^:]+):.+$/\1/'|sort|uniq)
PORTSERV=$(echo "$CONNECTIONS" |sed -r 's/^.+:(.+)->([^:]+):.+$/\1:\2/'|sort|uniq)

# define SERVERNAME, FROM and RCPT
. "$HOME/.config/stragglers.conf"

([[ -z "$THRESHOLD" ]] || [[ -z "$SERVERNAME" ]] || [[ -z "$FROM" ]] || [[ -z "$RCPT" ]]) && {
echo "Please define SERVERNAME (name of server), THRESHOLD (num of connections above which to restart apache), FROM and RCPT (sender and recipient emails) in $HOME/.config/stragglers.conf"
	exit 127
}

if [[ -z "$CONNECTIONS" ]]; then
	echo "Nothing to report."
	exit
else
	echo "Generating and sending report for $CONNCOUNT connections."
fi


IPpat="^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$" # I don't expect a wildly invalid IP to be returned by DNS tools...
IPpat2="^(([12]?)[0-9])?[0-9]\.(([12]?)[0-9])?[0-9]\.(([12]?)[0-9])?[0-9]\.(([12]?)[0-9])?[0-9]\.$" # more precise but I'm less sure of its validity
ABUSEF=/tmp/abuse
echo "">$ABUSEF
echo "$SERVERS"|while read SERV ; do
	[[ "$SERV" =~ $IPpat ]] || SERV=$(nslookup "$SERV" |egrep '^Name:' -A 1|grep 'Address:'|sed -r 's/Address:\s*//')
	echo "$SERV" | while read myaddr; do # cater for: if it was a name resolved to multiple addresses
		echo -e "\t// $myaddr" >> "$ABUSEF"
		whois "$myaddr"|egrep -i '((net|name).+:)|(abuse.*:)|Abuse contact|OrgAbuseEmail|OrgName' >> "$ABUSEF"
	done
done

REPORTFILE="/tmp/report-$(date "+%F-%T")"
cat <<EOF > "$REPORTFILE"

Report for $SERVERNAME

Connections: $CONNCOUNT


$(
if [[ $CONNCOUNT -gt $THRESHOLD ]]; then
	echo -e "	==== Apache Task ====\n\nRestarting apache\n"
	service apache2 restart 2>&1
	[[ $? -gt 0 ]] && {
		service --status-all | mailx -s "URGENT - $SERVERNAME apache restart failed" -r "$FROM" "$RCPT"
	}
fi
)

	==== Servers involved ====

$SERVERS

	==== Abuse details ====

$(cat $ABUSEF)

	==== All connections ====

$CONNECTIONS

	==== Ports to server ====

$PORTSERV

EOF

if [[ "$@" =~ "--stdout" ]]; then
	cat "$REPORTFILE" | less
else
	cat "$REPORTFILE"   | mailx -s "$SERVERNAME Open connections: $CONNCOUNT" -r "$FROM" "$RCPT"
fi
