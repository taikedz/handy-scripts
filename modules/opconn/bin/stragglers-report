#!/bin/bash

CONNECTIONS=$(lsof -i |grep -E 'http.+ESTABLISHED' )
CONNCOUNT=$(echo "$CONNECTIONS"|wc -l)
SERVERS=$(echo "$CONNECTIONS" |sed -r 's/^.+->([^:]+):.+$/\1/'|sort|uniq)
PORTSERV=$(echo "$CONNECTIONS" |sed -r 's/^.+:(.+)->([^:]+):.+$/\1:\2/'|sort|uniq)

# lib loading
LIBF="$HOME/bin/lib/straggle-lib.sh"
if [[ -f "$LIBF" ]]; then
	. "$LIBF"
else
	echo "No function library found for stragglers. Abort."
	exit 126
fi

# Configuration ===========
# define SERVERNAME, FROM and RCPT
CONFF="$HOME/.config/stragglers.conf"
[[ -f "$CONFF" ]] && . "$CONFF"

[[ $(echo -e "$THRESHOLD\n$SERVERNAME\n$FROM\n$RCPT\n$DBNAME\n$DBUSER\n$DBPASS"|sort|uniq|wc -l) -ne 7 ]] && {
	echo "Verify configuration file $CONFF"
	exit 127
}

# Delayed sender =============

for OPTS in $@; do
if [[ "$OPTS" =~ "--send=" ]]; then
	DESTFILE=${OPTS#--send=}
	mailx -s "$SERVERNAME Stragglers report" -r "$FROM" "$RCPT" < "$DESTFILE"
	if [[ $? -gt 0 ]]; then
		echo "Could not get report file $DESTFILE"|mailx -s "$SERVERNAME stragglers - no report file" -r "$FROM" "$RCPT"
	fi
fi
done

# ============== Do it now

if [[ -z "$CONNECTIONS" ]]; then
	exit
fi

echo "$PORTSERV" | while read pserv; do
	md5id=$(stg_md5 "$pserv")
	if [[ $(stg_getcontent $md5id|wc -l) -gt 0 ]]; then
		stg_setnotes $md5id "Old connection $(date "+%F-%T") $pserv"
		# do some other stuff here?
		# for ex ban the IP in question?
	else
		stg_insert "$pserv"
	fi
done

IPpat="^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$" # I don't expect a wildly invalid IP to be returned by DNS tools...

# Print abuse information
ABUSEF=/tmp/abuse
echo "">$ABUSEF
[[ 1 = 0 ]] && { # toggle
echo "$SERVERS"|while read SERV ; do
	[[ "$SERV" =~ $IPpat ]] || SERV=$(nslookup "$SERV" |egrep '^Name:' -A 1|grep 'Address:'|sed -r 's/Address:\s*//')
	echo "$SERV" | while read myaddr; do # cater for: if it was a name resolved to multiple addresses
		echo -e "\t// $myaddr" >> "$ABUSEF"
		whois "$myaddr"|egrep -i '((net|name).+:)|(abuse.*:)|Abuse contact|OrgAbuseEmail|OrgName' >> "$ABUSEF"
	done
done
}

REPORTFILE="/tmp/report-$(date "+%F-%T")"

if [[ $(stg_show|wc -l) -gt 1 ]]; then
cat <<EOF > "$REPORTFILE"

Report for $SERVERNAME

Old connections:

$(stg_show)


$(
	echo -e "Restarting apache\n"
	service apache2 restart 2>&1
	if [[ $? -gt 0 ]]; then
		service --status-all | mailx -s "URGENT - $SERVERNAME apache restart failed" -r "$FROM" "$RCPT"
	else
		stg_clearout
		stg_drop # drop the now-obsolete old-connection artefacts
	fi

)

	==== Servers involved ====

$SERVERS

EOF

if [[ "$@" =~ "--stdout" ]]; then
	cat "$REPORTFILE"
else
	cat "$REPORTFILE"   | mailx -s "$SERVERNAME Open connections: $CONNCOUNT" -r "$FROM" "$RCPT"
fi

fi # if stg_show greater than 1


