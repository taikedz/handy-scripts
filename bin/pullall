#! /bin/bash

function printhelp {
cat <<EOHELP

git-pull a whole load of git subfolders

List the parent directories to update as arguments

Each parent directory's children will be entered, checked to be git repositories
and if they can be updated safely, the script will do so, otherwise error will be
printed.

EOHELP
}

alldirs=

if [[ -z "$@" ]]; then
	printhelp
	exit 0
fi

while [[ -n "$@" ]]; do
	if [[ "$1" = "--help" ]]; then
		printhelp
		exit 0
	fi
	alldirs=$(echo "$1"|sed 's/ //g')
	shift
done

for topdir in "$alldirs"; do
	( cd $(echo "$topdir"|sed 's// /g')
	for thisdir in $(ls --color=never); do
		[[ -d "$thisdir" ]] && {
		(
		cd $thisdir
		[[ -d .git ]] && {
			if git fetch > /dev/null 2>&1 || [[ x = x ]]; then
				if [[ $(git status|grep -E "is up-to-date|working directory clean" -c) -gt 1 ]]; then
					git pull on $thisdir
				else
					echo "Cannot update $thisdir ----------Â¬"
					git status
				fi
			else
				echo "    Fetch failed on $thisdir"
			fi
		}
		)
		}
	done
	)
done
