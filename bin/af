#! /bin/bash

set -euo pipefail

ASSUMEYES=
PACKAGELIST=
ACTION=
CLEANUP=
UPDATE=

function printhelp {
	cat <<EOF
Usage

	$(basename $0) [ACTION] TERMS ... [OPTIONS]

ACTIONS

-l|--list
	List installed packages, use \`less\` pager.

-s|--show
	Show details of packages, use \`less\`pager.

-i|--install
	Install specified packages.

-g|--upgrade
	Do a system upgrade.

OPTIONS

-y|--assume-yes
	Use the --assume-yes flag for operations which would normally prompt you.

-ny|--no-assume-yes
	Do not use the --assume-yes flag. You will be prompted
	Supercedes a previously set '-y' option.

-u|--update
	Run an update of package listings.
	Can be specified without actions, or used with other actions.

-nu|--no-update
	Don't run an update of package listings.
	Supercedes a previously set '-u' option.

-c|--cleanup
	Perform an autoclean and autoremove.

-nc|--no-cleanup
	Donot perform any autoclean or autoremove
	Supercedes a previously set '-c' option.

The tool uses sudo to run actions that require root.

EOF
}

while [[ -n "$@" ]]; do
	ARG="$1" ; shift
	case "$ARG" in
	-l|--list)
		ACTION=list
		;;
	-i|--install)
		ACTION=install
		;;
	-s|--show)
		ACTION=show
		;;
	-g|--upgrade)
		ACTION=upgrade
		;;
	-y|--assume-yes)
		ASSUMEYES=-y
		;;
	-ny|--no-assume-yes)
		ASSUMEYES=
		;;
	-c|--cleanup)
		CLEANUP=yes
		;;
	-nc|--no-cleanup)
		CLEANUP=no
		;;
	-u|--update)
		UPDATE=yes
		;;
	-nu|--no-update)
		UPDATE=no
		;;
	--help)
		printhelp
		exit 0
		;;
	*)
		PACKAGELIST="$PACKAGELIST $ARG"
		;;
	esac
done

if [[ $UPDATE = yes ]]; then
	sudo apt-get update
fi


if [[ $ACTION = install ]]; then
	[[ -n "$PACKAGELIST" ]] && sudo apt-get install $PACKAGELIST $ASSUMEYES --show-progress
elif [[ $ACTION = upgrade ]]; then
	sudo apt-get upgrade $ASSUMEYES --show-progress
elif [[ $ACTION = list ]]; then
	dpkg -l | less
elif [[ $ACTION = show ]]; then
	[[ -n "$PACKAGELIST" ]] && apt-cache show $PACKAGELIST | sed -r 's/^(Package: )/[1;33m===[0m\n\1/' | less -R
elif [[ -z "$ACTION" ]]; then
	[[ -n "$PACKAGELIST" ]] && apt-cache search $PACKAGELIST | less
fi

if [[ $CLEANUP = yes ]]; then
	sudo apt-get autoremove $ASSUMEYES --show-progress
	sudo apt-get autoclean $ASSUMEYES --show-progress
fi
