#!/bin/bash

export blocked_ports=(80 21 8080)

die() {
    echo "$*"
    exit 1
}

is_root() {
    [[ "$UID" = 0 ]]
}

print_status() {
    local statuslines="$(ufw status)"
    for port in "${blocked_ports[@]}"; do
        ( echo "$statuslines" | grep "# secretmode" | grep -Po "$port") || {
            echo -e "\033[33;1mPort $port not applied\033[0m"
        }
    done | sort -V|uniq
}

print_confirmation() {
    case "$1" in
    on)
        echo -ne "\033[32;1m"
        ;;
    off)
        echo -ne "\033[31;1m"
        ;;
    esac

    echo -e "secret mode is $1\033[0m"
}

set_mode() {
    if [[ "$1" = on ]]; then    
        mode=(deny)
    elif [[ "$1" = off ]]; then
        mode=(delete deny)
    else
        die "Mode must be 'on' or 'off'"
    fi

    if [[ -n "${mode[*]}" ]]; then
        for port in "${blocked_ports[@]}"; do
            ufw "${mode[@]}" out "$port" comment secretmode
        done
    fi

    echo "Denied ports:"
    print_status
    print_confirmation "$1"
    exit 0
}

if is_root ; then
    if [[ -z "$*" ]]; then
        print_status
    else
        set_mode "$1"
    fi
else
    sudo "$0" "$@"
fi
