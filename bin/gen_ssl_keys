#!/bin/bash

[[ $# -lt 1 ]] && {
	echo "You must specify a name for the key family."
	exit 1
}

pat="^[0-9a-zA-Z._-]+$"
[[ ! "$1" =~ $pat ]] && {
	echo "Not valid: [$1]"
	exit 1
}

F_KEY=$1.key
F_CSR=$1.csr
F_CRT=$1.crt

#Generate Self-Signed Cert, then a CSR (cert signing req)

[[ -f "$F_KEY" ]] || {
echo "======= Generating Key ========="
openssl genrsa -out "$F_KEY" 2048
}

[[ -f "$F_CSR" ]] || {
echo "======= Generating CSR ========="
openssl req -new -key "$F_KEY" -out "$F_CSR"
}

#Challenge used for CSR "csrsign"

#Generate self-signed cert

echo -e "=======\nGenerating Certificate from CSR [$F_CSR] and Key [$F_KEY]\n========="
openssl x509 -req -days 30 -in "$F_CSR" -signkey "$F_KEY" -out "$F_CRT"

#Copy these to public key infrastructure stores

[[ $UID = 0 ]] && {
	echo "Root operation -- copying files to /etc/pki"
	mkdir -p /etc/pki/{certs,private}
	cp "$F_CRT" /etc/pki/certs/
	cp "$F_KEY" /etc/pki/private/
}

cat<<EOF
Now edit your Apache config

There should be a default-ssl in sites-available

Configure:

	SSLCertificateFile      /path/to/$F_CRT
	SSLCertificateKeyFile   /path/to/$F_KEY
EOF
