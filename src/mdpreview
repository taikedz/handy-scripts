#!/bin/bash

### mdpreview Usage:help
# Preview a markdown file
###/doc

#%include bashout readargs kvreader autohelp

set -u

MDEXEC=$(which markdown 2>/dev/null || which markdown_py 2>/dev/null)
BREXEC=$(which sensible-browser 2>/dev/null || which firefox 2>/dev/null || which chromium-browser 2>/dev/null || which elinks 2>/dev/null)
TMPDIR=/tmp


if [[ -z "$MDEXEC" ]] || [[ ! -f "$MDEXEC" ]]; then
	faile "No markdown processor"
fi

DEST=$(argread '-d')
if [[ -z "$DEST" ]]; then
	DEST="$TMPDIR"
fi

if [[ ! -d "$DEST" ]]; then
	faile "Invalid destination [$DEST]"
fi

function makeafile {
	if [[ "$DEST" = /tmp ]]; then
		echo "$(mktemp -d /tmp)"
	fi
}

ALLFILES=
for x in "$@"; do
	tfile=$(mktemp -p ./ .previewXXXX.html)
	ALLFILES="$ALLFILES $tfile"
	if [[ "$HOME/.markdown.css" ]]; then
		echo '<style>' > "$tfile"
		cat "$HOME/.markdown.css"  >> "$tfile"
		echo '</style>' >> "$tfile"
	fi
	"$MDEXEC" "$x" >> "$tfile"
	"$BREXEC" $tfile 2>/dev/null >/dev/null
done

if [[ -z "$BREXEC" ]]; then
	infoe "$ALLFILES"
else
	sleep 2
	rm $ALLFILES
fi
